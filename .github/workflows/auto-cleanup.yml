name: ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹

on:
  # ÙŠØ¹Ù…Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ ØªØ¹Ø¯ÙŠÙ„ Ù…Ù„Ù Codes
  push:
    paths:
      - 'Codes'
  
  # ÙŠØ¹Ù…Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙƒÙ„ 5 Ø¯Ù‚Ø§Ø¦Ù‚
  schedule:
    - cron: '*/5 * * * *'
  
  # ÙŠÙ…ÙƒÙ†Ùƒ ØªØ´ØºÙŠÙ„Ù‡ ÙŠØ¯ÙˆÙŠØ§Ù‹ Ø£ÙŠØ¶Ø§Ù‹
  workflow_dispatch:

permissions:
  contents: write

jobs:
  cleanup:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
      uses: actions/checkout@v3
    
    - name: ğŸ ØªØ«Ø¨ÙŠØª Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: ğŸ” ÙØ­Øµ ÙˆØ­Ø°Ù Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ©
      run: |
        cat << 'PYTHON_SCRIPT' > cleanup_temp.py
        from datetime import datetime, timedelta
        import sys
        
        def parse_duration(duration_str):
            """ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ø¯Ø© Ø¥Ù„Ù‰ timedelta"""
            duration_str = duration_str.strip().lower()
            try:
                if duration_str.endswith('s'):
                    return timedelta(seconds=int(duration_str[:-1]))
                elif duration_str.endswith('m'):
                    return timedelta(minutes=int(duration_str[:-1]))
                elif duration_str.endswith('h'):
                    return timedelta(hours=int(duration_str[:-1]))
                elif duration_str.endswith('d'):
                    return timedelta(days=int(duration_str[:-1]))
            except:
                return None
            return None
        
        print("=" * 60)
        print("ğŸ” Ø¨Ø¯Ø¡ ÙØ­Øµ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯...")
        print("=" * 60)
        
        try:
            with open('Codes', 'r', encoding='utf-8') as f:
                lines = f.readlines()
        except FileNotFoundError:
            print("âŒ Ù…Ù„Ù Codes ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!")
            sys.exit(0)
        
        now = datetime.now()
        print(f"â° Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ: {now.strftime('%Y-%m-%d %H:%M:%S')}")
        print()
        
        valid_codes = []
        deleted_count = 0
        
        for line in lines:
            line = line.strip()
            if not line:
                continue
            
            try:
                parts = line.split('|')
                if len(parts) != 3:
                    print(f"âš ï¸  Ø³Ø·Ø± Ø¨ØµÙŠØºØ© Ø®Ø§Ø·Ø¦Ø©: {line}")
                    continue
                
                code = parts[0].strip()
                date_str = parts[1].strip()
                duration_str = parts[2].strip()
                
                # ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ®
                code_date = datetime.fromisoformat(date_str)
                
                # ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø¯Ø©
                duration = parse_duration(duration_str)
                if duration is None:
                    print(f"âš ï¸  Ù…Ø¯Ø© ØºÙŠØ± ØµØ§Ù„Ø­Ø© Ù„Ù€ [{code}]: {duration_str}")
                    continue
                
                # Ø­Ø³Ø§Ø¨ ÙˆÙ‚Øª Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡
                expiry_date = code_date + duration
                time_diff = expiry_date - now
                
                if now < expiry_date:
                    # Ø§Ù„ÙƒÙˆØ¯ ØµØ§Ù„Ø­
                    valid_codes.append(line)
                    
                    # Ø­Ø³Ø§Ø¨ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ
                    total_seconds = int(time_diff.total_seconds())
                    if total_seconds > 86400:
                        remaining = f"{total_seconds // 86400} ÙŠÙˆÙ…"
                    elif total_seconds > 3600:
                        remaining = f"{total_seconds // 3600} Ø³Ø§Ø¹Ø©"
                    elif total_seconds > 60:
                        remaining = f"{total_seconds // 60} Ø¯Ù‚ÙŠÙ‚Ø©"
                    else:
                        remaining = f"{total_seconds} Ø«Ø§Ù†ÙŠØ©"
                    
                    print(f"âœ… [{code}] ØµØ§Ù„Ø­ - Ù…ØªØ¨Ù‚ÙŠ: {remaining}")
                else:
                    # Ø§Ù„ÙƒÙˆØ¯ Ù…Ù†ØªÙ‡ÙŠ
                    deleted_count += 1
                    
                    # Ø­Ø³Ø§Ø¨ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ù†Ù‚Ø¶ÙŠ
                    time_passed = now - expiry_date
                    total_seconds = int(time_passed.total_seconds())
                    if total_seconds > 86400:
                        passed = f"{total_seconds // 86400} ÙŠÙˆÙ…"
                    elif total_seconds > 3600:
                        passed = f"{total_seconds // 3600} Ø³Ø§Ø¹Ø©"
                    elif total_seconds > 60:
                        passed = f"{total_seconds // 60} Ø¯Ù‚ÙŠÙ‚Ø©"
                    else:
                        passed = f"{total_seconds} Ø«Ø§Ù†ÙŠØ©"
                    
                    print(f"ğŸ—‘ï¸  [{code}] Ù…Ù†ØªÙ‡ÙŠ Ù…Ù†Ø° {passed} - ØªÙ… Ø­Ø°ÙÙ‡")
            
            except Exception as e:
                print(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø³Ø·Ø±: {line}")
                print(f"   Ø§Ù„ØªÙØ§ØµÙŠÙ„: {str(e)}")
                continue
        
        # ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„ØµØ§Ù„Ø­Ø©
        with open('Codes', 'w', encoding='utf-8') as f:
            for code in valid_codes:
                f.write(code + '\n')
        
        print()
        print("=" * 60)
        print("âœ… ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø§Ù„ÙØ­Øµ!")
        print(f"ğŸ“Š Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„ØµØ§Ù„Ø­Ø©: {len(valid_codes)}")
        print(f"ğŸ—‘ï¸  Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©: {deleted_count}")
        print("=" * 60)
        
        # Ø¥Ø±Ø¬Ø§Ø¹ 0 Ø¥Ø°Ø§ ØªÙ… Ø­Ø°Ù Ø£ÙƒÙˆØ§Ø¯ØŒ 1 Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø­Ø°Ù Ø´ÙŠØ¡
        sys.exit(0 if deleted_count > 0 else 1)
        PYTHON_SCRIPT
        
        python cleanup_temp.py
        CLEANUP_EXIT_CODE=$?
        rm cleanup_temp.py
        
        echo "EXIT_CODE=$CLEANUP_EXIT_CODE" >> $GITHUB_ENV
    
    - name: ğŸ“¤ Ø±ÙØ¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "ğŸ¤– GitHub Actions Bot"
        
        # Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ù Codes
        git add Codes
        
        # ÙØ­Øµ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
        if git diff --staged --quiet; then
          echo "âœ… Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØºÙŠÙŠØ±Ø§Øª - Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ ØµØ§Ù„Ø­Ø©"
        else
          echo "ğŸ“ ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØªØºÙŠÙŠØ±Ø§Øª - Ø³ÙŠØªÙ… Ø±ÙØ¹Ù‡Ø§..."
          
          # Ø¹Ø±Ø¶ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          git diff --staged
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Ø¹Ù…Ù„ Commit
          TIMESTAMP=$(date +'%Y-%m-%d %H:%M:%S')
          git commit -m "ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ [$TIMESTAMP]"
          
          # Ø±ÙØ¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
          echo "â¬†ï¸ Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø¥Ù„Ù‰ GitHub..."
          git push origin main || git push origin master
          
          echo "âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!"
          echo "ğŸ”— ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ù„Ù: https://github.com/${{ github.repository }}/blob/main/Codes"
        fi
    
    - name: â„¹ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ÙƒÙˆØ§Ø¯ Ù…Ù†ØªÙ‡ÙŠØ©
      if: env.EXIT_CODE != '0'
      run: echo "âœ… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ù„Ø§ ØªØ²Ø§Ù„ ØµØ§Ù„Ø­Ø©"
