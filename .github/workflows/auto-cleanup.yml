name: ๐๏ธ ุญุฐู ุงูุฃููุงุฏ ุงูููุชููุฉ (ุฏููู)

on:
  # ูุนูู ุชููุงุฆูุงู ุนูุฏ ุชุนุฏูู ููู Codes
  push:
    paths:
      - 'Codes'
  
  # ูุนูู ุชููุงุฆูุงู ูู ุฏูููุฉ (ููุชุฃูุฏ)
  schedule:
    - cron: '* * * * *'
  
  # ููููู ุชุดุบููู ูุฏููุงู
  workflow_dispatch:

permissions:
  contents: write

jobs:
  cleanup:
    runs-on: ubuntu-latest
    
    steps:
    - name: ๐ฅ ุชุญููู ุงููุดุฑูุน
      uses: actions/checkout@v3
    
    - name: ๐ ุชุซุจูุช Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: ๐ ูุญุต ูุญุฐู ุงูุฃููุงุฏ ุงูููุชููุฉ (ุฏููู)
      run: |
        cat << 'PYTHON_SCRIPT' > cleanup_temp.py
        from datetime import datetime, timedelta
        import sys
        import os
        import time
        
        def parse_duration(duration_str):
            """ุชุญููู ุงููุฏุฉ ุฅูู timedelta"""
            duration_str = duration_str.strip().lower()
            try:
                if duration_str.endswith('s'):
                    return timedelta(seconds=int(duration_str[:-1]))
                elif duration_str.endswith('m'):
                    return timedelta(minutes=int(duration_str[:-1]))
                elif duration_str.endswith('h'):
                    return timedelta(hours=int(duration_str[:-1]))
                elif duration_str.endswith('d'):
                    return timedelta(days=int(duration_str[:-1]))
            except:
                return None
            return None
        
        print("=" * 70)
        print("๐ ุจุฏุก ูุญุต ุงูุฃููุงุฏ (ูุธุงู ุฏููู)...")
        print("=" * 70)
        
        # ุงูุชุฃูุฏ ูู ูุฌูุฏ ุงูููู
        if not os.path.exists('Codes'):
            print("โ ููู Codes ุบูุฑ ููุฌูุฏ!")
            sys.exit(1)
        
        # ูุฑุงุกุฉ ุงูููู
        try:
            with open('Codes', 'r', encoding='utf-8') as f:
                lines = f.readlines()
        except Exception as e:
            print(f"โ ุฎุทุฃ ูู ูุฑุงุกุฉ ุงูููู: {e}")
            sys.exit(1)
        
        now = datetime.utcnow()
        print(f"โฐ ุงูููุช ุงูุญุงูู (UTC): {now.strftime('%Y-%m-%d %H:%M:%S')}")
        print(f"โฐ ุจุงููููู ุซุงููุฉ: {now.strftime('%Y-%m-%d %H:%M:%S.%f')[:-3]}")
        print()
        
        valid_codes = []
        deleted_codes = []
        pending_codes = []
        deleted_count = 0
        
        # ุงููุฑุญูุฉ 1: ูุญุต ุฌููุน ุงูุฃููุงุฏ
        for line in lines:
            line = line.strip()
            if not line:
                continue
            
            try:
                parts = line.split('|')
                if len(parts) != 3:
                    print(f"โ๏ธ  ุณุทุฑ ุจุตูุบุฉ ุฎุงุทุฆุฉ: {line}")
                    continue
                
                code = parts[0].strip()
                date_str = parts[1].strip()
                duration_str = parts[2].strip()
                
                # ุชุญููู ุงูุชุงุฑูุฎ
                code_date = datetime.fromisoformat(date_str)
                
                # ุชุญููู ุงููุฏุฉ
                duration = parse_duration(duration_str)
                if duration is None:
                    print(f"โ๏ธ  ูุฏุฉ ุบูุฑ ุตุงูุญุฉ ูู [{code}]: {duration_str}")
                    continue
                
                # ุญุณุงุจ ููุช ุงูุงูุชูุงุก
                expiry_date = code_date + duration
                time_diff = (expiry_date - now).total_seconds()
                
                if time_diff > 0:
                    # ุงูููุฏ ูุง ูุฒุงู ุตุงูุญุงู
                    valid_codes.append(line)
                    
                    # ุญุณุงุจ ุงูููุช ุงููุชุจูู
                    if time_diff > 86400:
                        remaining = f"{int(time_diff // 86400)} ููู"
                    elif time_diff > 3600:
                        remaining = f"{int(time_diff // 3600)} ุณุงุนุฉ"
                    elif time_diff > 60:
                        remaining = f"{int(time_diff // 60)} ุฏูููุฉ"
                    else:
                        remaining = f"{int(time_diff)} ุซุงููุฉ"
                    
                    print(f"โ [{code}] ุตุงูุญ - ูุชุจูู: {remaining}")
                    
                    # ุฅุฐุง ูุงู ุณููุชูู ุฎูุงู ุฏูููุชููุ ูุถุนู ูู ูุงุฆูุฉ ุงูุงูุชุธุงุฑ
                    if time_diff <= 120:
                        pending_codes.append({
                            'code': code,
                            'line': line,
                            'expiry': expiry_date,
                            'wait_seconds': time_diff
                        })
                        print(f"   โณ ุณููุชูู ุฎูุงู {int(time_diff)} ุซุงููุฉ - ูู ูุงุฆูุฉ ุงูุงูุชุธุงุฑ")
                
                else:
                    # ุงูููุฏ ููุชูู
                    deleted_count += 1
                    deleted_codes.append(code)
                    
                    # ุญุณุงุจ ุงูููุช ุงููููุถู
                    time_passed = abs(time_diff)
                    if time_passed > 86400:
                        passed = f"{int(time_passed // 86400)} ููู"
                    elif time_passed > 3600:
                        passed = f"{int(time_passed // 3600)} ุณุงุนุฉ"
                    elif time_passed > 60:
                        passed = f"{int(time_passed // 60)} ุฏูููุฉ"
                    else:
                        passed = f"{int(time_passed)} ุซุงููุฉ"
                    
                    print(f"๐๏ธ  [{code}] ููุชูู ููุฐ {passed} - ุณูุชู ุญุฐูู")
            
            except Exception as e:
                print(f"โ ุฎุทุฃ ูู ูุนุงูุฌุฉ ุงูุณุทุฑ: {line}")
                print(f"   ุงูุชูุงุตูู: {str(e)}")
                continue
        
        print()
        print("=" * 70)
        
        # ุงููุฑุญูุฉ 2: ุงูุงูุชุธุงุฑ ุงูุฏููู ููุฃููุงุฏ ุงููุฑูุจุฉ ูู ุงูุงูุชูุงุก
        if pending_codes:
            print(f"โณ ุงูุชุธุงุฑ ุฏููู ูู {len(pending_codes)} ููุฏ(ุฃููุงุฏ) ูุฑูุจ(ุฉ) ูู ุงูุงูุชูุงุก...")
            print("=" * 70)
            
            for item in pending_codes:
                if item['wait_seconds'] > 0:
                    print(f"โฑ๏ธ  ุงูุชุธุงุฑ {int(item['wait_seconds'])} ุซุงููุฉ ูู [{item['code']}]...")
                    time.sleep(item['wait_seconds'])
                    
                    # ุฅุฒุงูุฉ ูู ุงููุงุฆูุฉ ุงูุตุงูุญุฉ ูุฅุถุงูุฉ ูููุญุฐููุฉ
                    valid_codes.remove(item['line'])
                    deleted_codes.append(item['code'])
                    deleted_count += 1
                    
                    now_after = datetime.utcnow()
                    print(f"โ [{item['code']}] ุชู ุญุฐูู ูู {now_after.strftime('%H:%M:%S')} ุจุงูุถุจุท!")
            
            print("=" * 70)
        
        # ูุชุงุจุฉ ุงูุฃููุงุฏ ุงูุตุงูุญุฉ ููุท
        try:
            with open('Codes', 'w', encoding='utf-8') as f:
                for code in valid_codes:
                    f.write(code + '\n')
            
            print(f"โ ุชู ุชุญุฏูุซ ููู Codes ุจูุฌุงุญ")
            print(f"๐ ุงูุฃููุงุฏ ุงูุตุงูุญุฉ: {len(valid_codes)}")
            print(f"๐๏ธ  ุงูุฃููุงุฏ ุงููุญุฐููุฉ: {deleted_count}")
            
            if deleted_count > 0:
                print(f"\n๐ ุงูุฃููุงุฏ ุงูุชู ุชู ุญุฐููุง:")
                for code in deleted_codes:
                    print(f"   โข {code}")
        
        except Exception as e:
            print(f"โ ุฎุทุฃ ูู ูุชุงุจุฉ ุงูููู: {e}")
            sys.exit(1)
        
        print("=" * 70)
        
        # ุงูุชุญูู ูู ุงููุชุงุจุฉ
        try:
            with open('Codes', 'r', encoding='utf-8') as f:
                new_content = f.read()
                print(f"\nโ ูุญุชูู ุงูููู ุจุนุฏ ุงูุญุฐู:")
                print("โ" * 50)
                print(new_content if new_content.strip() else "(ุงูููู ูุงุฑุบ - ุชู ุญุฐู ุฌููุน ุงูุฃููุงุฏ)")
                print("โ" * 50)
        except:
            pass
        
        # ุฅุฑุฌุงุน 0 ุฅุฐุง ุชู ุญุฐู ุฃููุงุฏ
        sys.exit(0 if deleted_count > 0 else 1)
        PYTHON_SCRIPT
        
        timeout 600 python cleanup_temp.py
        CLEANUP_EXIT_CODE=$?
        rm -f cleanup_temp.py
        
        echo "CLEANUP_RESULT=$CLEANUP_EXIT_CODE" >> $GITHUB_ENV
    
    - name: ๐ค ุฑูุน ุงูุชุบููุฑุงุช
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "๐ค GitHub Actions Bot"
        
        # ุฅุถุงูุฉ ููู Codes
        git add Codes
        
        # ูุญุต ุงูุชุบููุฑุงุช
        if git diff --staged --quiet; then
          echo "โ ูุง ุชูุฌุฏ ุชุบููุฑุงุช - ุฌููุน ุงูุฃููุงุฏ ุตุงูุญุฉ"
        else
          echo "๐ ุชู ุงูุนุซูุฑ ุนูู ุชุบููุฑุงุช - ุณูุชู ุฑูุนูุง..."
          
          # ุนุฑุถ ุงูุชุบููุฑุงุช
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          git diff --staged
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          
          # ุนูู Commit
          TIMESTAMP=$(date +'%Y-%m-%d %H:%M:%S')
          git commit -m "๐๏ธ ุญุฐู ุฏููู ููุฃููุงุฏ ุงูููุชููุฉ [$TIMESTAMP]"
          
          # ุฑูุน ุงูุชุบููุฑุงุช
          echo "โฌ๏ธ ุฌุงุฑู ุฑูุน ุงูุชุบููุฑุงุช ุฅูู GitHub..."
          git push origin main || git push origin master
          
          echo "โ ุชู ุฑูุน ุงูุชุบููุฑุงุช ุจูุฌุงุญ!"
          echo "๐ ุชุญูู ูู ุงูููู: https://github.com/${{ github.repository }}/blob/main/Codes"
        fi
    
    - name: โน๏ธ ูุง ุชูุฌุฏ ุฃููุงุฏ ููุชููุฉ
      if: env.CLEANUP_RESULT != '0'
      run: echo "โ ุฌููุน ุงูุฃููุงุฏ ูุง ุชุฒุงู ุตุงูุญุฉ - ูุง ุชูุฌุฏ ุชุบููุฑุงุช"
