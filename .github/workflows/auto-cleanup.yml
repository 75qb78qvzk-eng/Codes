‚Äèname: Auto Delete Expired Codes

on:
  push:
    paths:
      - 'Codes'
  
  schedule:
    - cron: '* * * * *'
  
  workflow_dispatch:

permissions:
  contents: write

jobs:
  cleanup:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Check and Delete Expired Codes
      run: |
        cat << 'PYTHON_SCRIPT' > cleanup_temp.py
        from datetime import datetime, timedelta
        import sys
        import os
        import time
        import re
        
        def parse_duration(duration_str):
            duration_str = duration_str.strip().lower()
            try:
                if duration_str.endswith('s'):
                    return timedelta(seconds=int(duration_str[:-1]))
                elif duration_str.endswith('m'):
                    return timedelta(minutes=int(duration_str[:-1]))
                elif duration_str.endswith('h'):
                    return timedelta(hours=int(duration_str[:-1]))
                elif duration_str.endswith('d'):
                    return timedelta(days=int(duration_str[:-1]))
            except:
                return None
            return None
        
        print("=" * 70)
        print("Checking codes (smart system)...")
        print("=" * 70)
        
        if not os.path.exists('Codes'):
            print("Codes file not found!")
            sys.exit(1)
        
        try:
            with open('Codes', 'r', encoding='utf-8') as f:
                lines = f.readlines()
        except Exception as e:
            print(f"Error reading file: {e}")
            sys.exit(1)
        
        now = datetime.utcnow()
        print(f"Current time (UTC): {now.strftime('%Y-%m-%d %H:%M:%S.%f')[:-3]}")
        print()
        
        valid_codes = []
        deleted_codes = []
        pending_codes = []
        deleted_count = 0
        updated_lines = []
        
        for line_num, line in enumerate(lines, 1):
            original_line = line
            line = line.strip()
            if not line:
                continue
            
            try:
                parts = line.split('|')
                
                if len(parts) == 2:
                    code = parts[0].strip()
                    duration_str = parts[1].strip()
                    
                    duration = parse_duration(duration_str)
                    if duration is None:
                        print(f"Line {line_num}: Invalid duration - {duration_str}")
                        continue
                    
                    code_date = now
                    full_line = f"{code}|{now.strftime('%Y-%m-%dT%H:%M:%S')}|{duration_str}"
                    updated_lines.append((line_num, original_line, full_line))
                    
                    print(f"[{code}] Auto-added timestamp")
                    print(f"   From: {line}")
                    print(f"   To: {full_line}")
                    
                    expiry_date = code_date + duration
                    time_diff = (expiry_date - now).total_seconds()
                    
                    if time_diff > 0:
                        valid_codes.append(full_line)
                        
                        if time_diff > 86400:
                            remaining = f"{int(time_diff // 86400)} day"
                        elif time_diff > 3600:
                            remaining = f"{int(time_diff // 3600)} hr"
                        elif time_diff > 60:
                            remaining = f"{int(time_diff // 60)} min"
                        else:
                            remaining = f"{int(time_diff)} sec"
                        
                        print(f"   Valid - Remaining: {remaining}")
                        
                        if time_diff <= 120:
                            pending_codes.append({
                                'code': code,
                                'line': full_line,
                                'expiry': expiry_date,
                                'wait_seconds': time_diff
                            })
                            print(f"   Will expire in {int(time_diff)} sec - Waiting")
                    
                    print()
                    continue
                
                elif len(parts) == 3:
                    code = parts[0].strip()
                    date_str = parts[1].strip()
                    duration_str = parts[2].strip()
                    
                    code_date = datetime.fromisoformat(date_str)
                    
                    duration = parse_duration(duration_str)
                    if duration is None:
                        print(f"Line {line_num}: Invalid duration - {duration_str}")
                        continue
                    
                    expiry_date = code_date + duration
                    time_diff = (expiry_date - now).total_seconds()
                    
                    if time_diff > 0:
                        valid_codes.append(line)
                        
                        if time_diff > 86400:
                            remaining = f"{int(time_diff // 86400)} day"
                        elif time_diff > 3600:
                            remaining = f"{int(time_diff // 3600)} hr"
                        elif time_diff > 60:
                            remaining = f"{int(time_diff // 60)} min"
                        else:
                            remaining = f"{int(time_diff)} sec"
                        
                        print(f"[{code}] Valid - Remaining: {remaining}")
                        
                        if time_diff <= 120:
                            pending_codes.append({
                                'code': code,
                                'line': line,
                                'expiry': expiry_date,
                                'wait_seconds': time_diff
                            })
                            print(f"   Will expire in {int(time_diff)} sec - Waiting")
                    
                    else:
                        deleted_count += 1
                        deleted_codes.append(code)
                        
                        time_passed = abs(time_diff)
                        if time_passed > 86400:
                            passed = f"{int(time_passed // 86400)} day"
                        elif time_passed > 3600:
                            passed = f"{int(time_passed // 3600)} hr"
                        elif time_passed > 60:
                            passed = f"{int(time_passed // 60)} min"
                        else:
                            passed = f"{int(time_passed)} sec"
                        
                        print(f"[{code}] Expired {passed} ago - Deleting")
                
                else:
                    print(f"Line {line_num}: Wrong format - {line}")
                    continue
            
            except Exception as e:
                print(f"Error on line {line_num}: {line}")
                print(f"   Details: {str(e)}")
                continue
        
        print()
        print("=" * 70)
        
        if pending_codes:
            print(f"Waiting for {len(pending_codes)} code(s) to expire...")
            print("=" * 70)
            
            for item in pending_codes:
                if item['wait_seconds'] > 0:
                    print(f"Waiting {int(item['wait_seconds'])} sec for [{item['code']}]...")
                    time.sleep(item['wait_seconds'])
                    
                    valid_codes.remove(item['line'])
                    deleted_codes.append(item['code'])
                    deleted_count += 1
                    
                    now_after = datetime.utcnow()
                    print(f"[{item['code']}] Deleted at {now_after.strftime('%H:%M:%S.%f')[:-3]} exactly!")
            
            print("=" * 70)
        
        try:
            with open('Codes', 'w', encoding='utf-8') as f:
                for code in valid_codes:
                    f.write(code + '\n')
            
            print(f"File updated successfully")
            print(f"Valid codes: {len(valid_codes)}")
            print(f"Deleted codes: {deleted_count}")
            
            if updated_lines:
                print(f"Updated timestamps: {len(updated_lines)}")
            
            if deleted_count > 0:
                print(f"\nDeleted codes:")
                for code in deleted_codes:
                    print(f"   - {code}")
        
        except Exception as e:
            print(f"Error writing file: {e}")
            sys.exit(1)
        
        print("=" * 70)
        
        try:
            with open('Codes', 'r', encoding='utf-8') as f:
                new_content = f.read()
                print(f"\nFile content after update:")
                print("-" * 50)
                print(new_content if new_content.strip() else "(Empty file)")
                print("-" * 50)
        except:
            pass
        
        sys.exit(0 if (deleted_count > 0 or updated_lines) else 1)
        PYTHON_SCRIPT
        
        timeout 600 python cleanup_temp.py
        CLEANUP_EXIT_CODE=$?
        rm -f cleanup_temp.py
        
        echo "CLEANUP_RESULT=$CLEANUP_EXIT_CODE" >> $GITHUB_ENV
    
    - name: Upload Changes
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "GitHub Actions Bot"
        
        git add Codes
        
        if git diff --staged --quiet; then
          echo "No changes"
        else
          echo "Changes found - uploading..."
          
          echo "============================================"
          git diff --staged
          echo "============================================"
          
          TIMESTAMP=$(date +'%Y-%m-%d %H:%M:%S')
          git commit -m "Auto update and delete codes [$TIMESTAMP]"
          
          echo "Uploading changes to GitHub..."
          git push origin main || git push origin master
          
          echo "Changes uploaded successfully!"
          echo "Check file: https://github.com/${{ github.repository }}/blob/main/Codes"
        fi
    
    - name: No Changes
      if: env.CLEANUP_RESULT != '0'
      run: echo "All codes are valid - no changes"
