â€name: ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ© (ØªÙ„Ù‚Ø§Ø¦ÙŠ)

on:
  # ÙŠØ¹Ù…Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ ØªØ¹Ø¯ÙŠÙ„ Ù…Ù„Ù Codes
  push:
    paths:
      - 'Codes'
  
  # ÙŠØ¹Ù…Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚Ø©
  schedule:
    - cron: '* * * * *'
  
  # ÙŠÙ…ÙƒÙ†Ùƒ ØªØ´ØºÙŠÙ„Ù‡ ÙŠØ¯ÙˆÙŠØ§Ù‹
  workflow_dispatch:

permissions:
  contents: write

jobs:
  cleanup:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
      uses: actions/checkout@v3
    
    - name: ğŸ ØªØ«Ø¨ÙŠØª Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: ğŸ” ÙØ­Øµ ÙˆØ­Ø°Ù Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ© (ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø°ÙƒÙŠ)
      run: |
        cat << 'PYTHON_SCRIPT' > cleanup_temp.py
        from datetime import datetime, timedelta
        import sys
        import os
        import time
        import re
        
        def parse_duration(duration_str):
            """ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ø¯Ø© Ø¥Ù„Ù‰ timedelta"""
            duration_str = duration_str.strip().lower()
            try:
                if duration_str.endswith('s'):
                    return timedelta(seconds=int(duration_str[:-1]))
                elif duration_str.endswith('m'):
                    return timedelta(minutes=int(duration_str[:-1]))
                elif duration_str.endswith('h'):
                    return timedelta(hours=int(duration_str[:-1]))
                elif duration_str.endswith('d'):
                    return timedelta(days=int(duration_str[:-1]))
            except:
                return None
            return None
        
        print("=" * 70)
        print("ğŸ” Ø¨Ø¯Ø¡ ÙØ­Øµ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ (Ù†Ø¸Ø§Ù… Ø°ÙƒÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠ)...")
        print("=" * 70)
        
        # Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ù„Ù
        if not os.path.exists('Codes'):
            print("âŒ Ù…Ù„Ù Codes ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!")
            sys.exit(1)
        
        # Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù
        try:
            with open('Codes', 'r', encoding='utf-8') as f:
                lines = f.readlines()
        except Exception as e:
            print(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù: {e}")
            sys.exit(1)
        
        now = datetime.utcnow()
        print(f"â° Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ (UTC): {now.strftime('%Y-%m-%d %H:%M:%S.%f')[:-3]}")
        print()
        
        valid_codes = []
        deleted_codes = []
        pending_codes = []
        deleted_count = 0
        updated_lines = []
        
        # Ø§Ù„Ù…Ø±Ø­Ù„Ø© 1: ÙØ­Øµ ÙˆØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯
        for line_num, line in enumerate(lines, 1):
            original_line = line
            line = line.strip()
            if not line:
                continue
            
            try:
                parts = line.split('|')
                
                # Ø§Ù„ØµÙŠØºØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©: code|duration (Ø¨Ø¯ÙˆÙ† ØªØ§Ø±ÙŠØ®)
                if len(parts) == 2:
                    code = parts[0].strip()
                    duration_str = parts[1].strip()
                    
                    # ØªØ­ÙˆÙŠÙ„ Ù„Ù„ØµÙŠØºØ© Ø§Ù„ÙƒØ§Ù…Ù„Ø© Ø¨Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ
                    duration = parse_duration(duration_str)
                    if duration is None:
                        print(f"âš ï¸  Ø³Ø·Ø± {line_num}: Ù…Ø¯Ø© ØºÙŠØ± ØµØ§Ù„Ø­Ø© - {duration_str}")
                        continue
                    
                    # Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ
                    code_date = now
                    full_line = f"{code}|{now.strftime('%Y-%m-%dT%H:%M:%S')}|{duration_str}"
                    updated_lines.append((line_num, original_line, full_line))
                    
                    print(f"ğŸ†• [{code}] ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªÙˆÙ‚ÙŠØª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹")
                    print(f"   ğŸ“ Ù…Ù†: {line}")
                    print(f"   ğŸ“ Ø¥Ù„Ù‰: {full_line}")
                    
                    # Ø­Ø³Ø§Ø¨ ÙˆÙ‚Øª Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡
                    expiry_date = code_date + duration
                    time_diff = (expiry_date - now).total_seconds()
                    
                    if time_diff > 0:
                        valid_codes.append(full_line)
                        
                        if time_diff > 86400:
                            remaining = f"{int(time_diff // 86400)} ÙŠÙˆÙ…"
                        elif time_diff > 3600:
                            remaining = f"{int(time_diff // 3600)} Ø³Ø§Ø¹Ø©"
                        elif time_diff > 60:
                            remaining = f"{int(time_diff // 60)} Ø¯Ù‚ÙŠÙ‚Ø©"
                        else:
                            remaining = f"{int(time_diff)} Ø«Ø§Ù†ÙŠØ©"
                        
                        print(f"   âœ… ØµØ§Ù„Ø­ - Ù…ØªØ¨Ù‚ÙŠ: {remaining}")
                        
                        if time_diff <= 120:
                            pending_codes.append({
                                'code': code,
                                'line': full_line,
                                'expiry': expiry_date,
                                'wait_seconds': time_diff
                            })
                            print(f"   â³ Ø³ÙŠÙ†ØªÙ‡ÙŠ Ø®Ù„Ø§Ù„ {int(time_diff)} Ø«Ø§Ù†ÙŠØ© - ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±")
                    
                    print()
                    continue
                
                # Ø§Ù„ØµÙŠØºØ© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©: code|date|duration (Ù…Ø¹ ØªØ§Ø±ÙŠØ®)
                elif len(parts) == 3:
                    code = parts[0].strip()
                    date_str = parts[1].strip()
                    duration_str = parts[2].strip()
                    
                    # ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ®
                    code_date = datetime.fromisoformat(date_str)
                    
                    # ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø¯Ø©
                    duration = parse_duration(duration_str)
                    if duration is None:
                        print(f"âš ï¸  Ø³Ø·Ø± {line_num}: Ù…Ø¯Ø© ØºÙŠØ± ØµØ§Ù„Ø­Ø© - {duration_str}")
                        continue
                    
                    # Ø­Ø³Ø§Ø¨ ÙˆÙ‚Øª Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡
                    expiry_date = code_date + duration
                    time_diff = (expiry_date - now).total_seconds()
                    
                    if time_diff > 0:
                        valid_codes.append(line)
                        
                        if time_diff > 86400:
                            remaining = f"{int(time_diff // 86400)} ÙŠÙˆÙ…"
                        elif time_diff > 3600:
                            remaining = f"{int(time_diff // 3600)} Ø³Ø§Ø¹Ø©"
                        elif time_diff > 60:
                            remaining = f"{int(time_diff // 60)} Ø¯Ù‚ÙŠÙ‚Ø©"
                        else:
                            remaining = f"{int(time_diff)} Ø«Ø§Ù†ÙŠØ©"
                        
                        print(f"âœ… [{code}] ØµØ§Ù„Ø­ - Ù…ØªØ¨Ù‚ÙŠ: {remaining}")
                        
                        if time_diff <= 120:
                            pending_codes.append({
                                'code': code,
                                'line': line,
                                'expiry': expiry_date,
                                'wait_seconds': time_diff
                            })
                            print(f"   â³ Ø³ÙŠÙ†ØªÙ‡ÙŠ Ø®Ù„Ø§Ù„ {int(time_diff)} Ø«Ø§Ù†ÙŠØ© - ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±")
                    
                    else:
                        deleted_count += 1
                        deleted_codes.append(code)
                        
                        time_passed = abs(time_diff)
                        if time_passed > 86400:
                            passed = f"{int(time_passed // 86400)} ÙŠÙˆÙ…"
                        elif time_passed > 3600:
                            passed = f"{int(time_passed // 3600)} Ø³Ø§Ø¹Ø©"
                        elif time_passed > 60:
                            passed = f"{int(time_passed // 60)} Ø¯Ù‚ÙŠÙ‚Ø©"
                        else:
                            passed = f"{int(time_passed)} Ø«Ø§Ù†ÙŠØ©"
                        
                        print(f"ğŸ—‘ï¸  [{code}] Ù…Ù†ØªÙ‡ÙŠ Ù…Ù†Ø° {passed} - Ø³ÙŠØªÙ… Ø­Ø°ÙÙ‡")
                
                else:
                    print(f"âš ï¸  Ø³Ø·Ø± {line_num}: ØµÙŠØºØ© Ø®Ø§Ø·Ø¦Ø© - {line}")
                    continue
            
            except Exception as e:
                print(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø³Ø·Ø± {line_num}: {line}")
                print(f"   Ø§Ù„ØªÙØ§ØµÙŠÙ„: {str(e)}")
                continue
        
        print()
        print("=" * 70)
        
        # Ø§Ù„Ù…Ø±Ø­Ù„Ø© 2: Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¯Ù‚ÙŠÙ‚ Ù„Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù‚Ø±ÙŠØ¨Ø© Ù…Ù† Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡
        if pending_codes:
            print(f"â³ Ø§Ù†ØªØ¸Ø§Ø± Ø¯Ù‚ÙŠÙ‚ Ù„Ù€ {len(pending_codes)} ÙƒÙˆØ¯(Ø£ÙƒÙˆØ§Ø¯) Ù‚Ø±ÙŠØ¨(Ø©) Ù…Ù† Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡...")
            print("=" * 70)
            
            for item in pending_codes:
                if item['wait_seconds'] > 0:
                    print(f"â±ï¸  Ø§Ù†ØªØ¸Ø§Ø± {int(item['wait_seconds'])} Ø«Ø§Ù†ÙŠØ© Ù„Ù€ [{item['code']}]...")
                    time.sleep(item['wait_seconds'])
                    
                    valid_codes.remove(item['line'])
                    deleted_codes.append(item['code'])
                    deleted_count += 1
                    
                    now_after = datetime.utcnow()
                    print(f"âœ“ [{item['code']}] ØªÙ… Ø­Ø°ÙÙ‡ ÙÙŠ {now_after.strftime('%H:%M:%S.%f')[:-3]} Ø¨Ø§Ù„Ø¶Ø¨Ø·!")
            
            print("=" * 70)
        
        # ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„ØµØ§Ù„Ø­Ø© ÙÙ‚Ø·
        try:
            with open('Codes', 'w', encoding='utf-8') as f:
                for code in valid_codes:
                    f.write(code + '\n')
            
            print(f"âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ù…Ù„Ù Codes Ø¨Ù†Ø¬Ø§Ø­")
            print(f"ğŸ“Š Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„ØµØ§Ù„Ø­Ø©: {len(valid_codes)}")
            print(f"ğŸ—‘ï¸  Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©: {deleted_count}")
            
            if updated_lines:
                print(f"ğŸ†• Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„ØªÙŠ ØªÙ… ØªØ­Ø¯ÙŠØ« ØªÙˆÙ‚ÙŠØªÙ‡Ø§: {len(updated_lines)}")
            
            if deleted_count > 0:
                print(f"\nğŸ“ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„ØªÙŠ ØªÙ… Ø­Ø°ÙÙ‡Ø§:")
                for code in deleted_codes:
                    print(f"   â€¢ {code}")
        
        except Exception as e:
            print(f"âŒ Ø®Ø·Ø£ ÙÙŠ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ù…Ù„Ù: {e}")
            sys.exit(1)
        
        print("=" * 70)
        
        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙƒØªØ§Ø¨Ø©
        try:
            with open('Codes', 'r', encoding='utf-8') as f:
                new_content = f.read()
                print(f"\nâœ“ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù„Ù Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ«:")
                print("â”€" * 50)
                print(new_content if new_content.strip() else "(Ø§Ù„Ù…Ù„Ù ÙØ§Ø±Øº - ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯)")
                print("â”€" * 50)
        except:
            pass
        
        # Ø¥Ø±Ø¬Ø§Ø¹ 0 Ø¥Ø°Ø§ ØªÙ… Ø­Ø°Ù Ø£ÙƒÙˆØ§Ø¯ Ø£Ùˆ ØªØ­Ø¯ÙŠØ«
        sys.exit(0 if (deleted_count > 0 or updated_lines) else 1)
        PYTHON_SCRIPT
        
        timeout 600 python cleanup_temp.py
        CLEANUP_EXIT_CODE=$?
        rm -f cleanup_temp.py
        
        echo "CLEANUP_RESULT=$CLEANUP_EXIT_CODE" >> $GITHUB_ENV
    
    - name: ğŸ“¤ Ø±ÙØ¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "ğŸ¤– GitHub Actions Bot"
        
        git add Codes
        
        if git diff --staged --quiet; then
          echo "âœ… Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØºÙŠÙŠØ±Ø§Øª"
        else
          echo "ğŸ“ ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ØªØºÙŠÙŠØ±Ø§Øª - Ø³ÙŠØªÙ… Ø±ÙØ¹Ù‡Ø§..."
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          git diff --staged
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          TIMESTAMP=$(date +'%Y-%m-%d %H:%M:%S')
          git commit -m "ğŸ—‘ï¸ ØªØ­Ø¯ÙŠØ« ÙˆØ­Ø°Ù Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ [$TIMESTAMP]"
          
          echo "â¬†ï¸ Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø¥Ù„Ù‰ GitHub..."
          git push origin main || git push origin master
          
          echo "âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!"
          echo "ğŸ”— ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ù„Ù: https://github.com/${{ github.repository }}/blob/main/Codes"
        fi
    
    - name: â„¹ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØºÙŠÙŠØ±Ø§Øª
      if: env.CLEANUP_RESULT != '0'
      run: echo "âœ… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ ØµØ§Ù„Ø­Ø© - Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØºÙŠÙŠØ±Ø§Øª"
